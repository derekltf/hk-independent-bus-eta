"use strict";(self.webpackChunkhk_independent_bus_eta=self.webpackChunkhk_independent_bus_eta||[]).push([[635],{3310:function(t,e,n){var r=n(7313),a=n(5281),o=n(1113),c=n(4511),i=n(7440),s=n(9878),l=n(6417);e.Z=function(t){var e=t.routeId,n=t.seq,u=t.containerClass,d=void 0===u?"":u,p=t.showStopName,m=void 0!==p&&p,f=(0,c.$)(),g=f.t,h=f.i18n,x=(0,r.useContext)(i.Z),v=x.db,Z=v.routeList,b=v.stopList,k=x.etaFormat,j=(0,s.e)("".concat(e,"/").concat(n));if(null==j)return(0,l.jsx)("div",{className:d,children:(0,l.jsx)(a.Z,{size:20,style:{}})});var C=function(t){if(!t)return"";var e=Math.round((new Date(t).getTime()-(new Date).getTime())/60/1e3);if(!Number.isInteger(e))return t.remark[h.language];var n=t.substr(11,5),r=e<1?"- ".concat(g("\u5206\u9418")):"".concat(e," ").concat(g("\u5206\u9418"));switch(k){case"exact":return n;case"diff":return r;default:return"".concat(n," (").concat(r,")")}},y=Object.values(Z[e].stops)[0][n];return(0,l.jsxs)("div",{className:d,children:[m?(0,l.jsx)(o.Z,{variant:"caption",children:b[y].name[h.language]}):null,0===j.length?g("\u672a\u6709\u73ed\u6b21\u8cc7\u6599"):j.map((function(t,e){return(0,l.jsxs)(o.Z,{variant:"subtitle1",children:[C(t.eta)," -"," ",t.remark[h.language]?t.remark[h.language]:""," ",g(t.co)]},"route-".concat(e))}))]})}},1635:function(t,e,n){n.r(e),n.d(e,{default:function(){return st}});var r=n(4942),a=n(1413),o=n(9439),c=n(3433),i=n(7313),s=n(7829),l=n(5281),u=n(1113),d=n(4313),p=n(2295),m=n(8564),f=n(7440),g=n(5640),h=n(4511),x=n(936),v=n.n(x),Z=n(7504),b=n(6208),k=n(6417),j=function(t,e){return t?fetch("https://geodata.gov.hk/gs/api/v1.0.0/locationSearch?q=".concat(encodeURI(t)),e).then((function(t){return t.json()})).then((function(t){return t.map((function(t){var e=(0,b.Z)("+proj=tmerc +lat_0=22.31213333333334 +lon_0=114.1785555555556 +k=1 +x_0=836694.05 +y_0=819069.8 +ellps=intl +towgs84=-162.619,-276.959,-161.764,0.067753,-2.24365,-1.15883,-1.09425 +units=m +no_defs","+proj=longlat +ellps=WGS84 +datum=WGS84 +no_defs",[t.x,t.y]),n=(0,o.Z)(e,2),r=n[0],a=n[1];return{address:{zh:t.addressZH,en:t.addressEN},name:{zh:t.nameZH,en:t.nameEN},lat:a,lng:r}}))})):new Promise((function(t){return t([])}))},C=function(t){var e=t.placeholder,n=void 0===e?"":e,r=t.onChange,a=t.stopList,o=t.value,c=(0,h.$)(),s=c.t,l=c.i18n,u=(0,i.useRef)(new AbortController),d=(0,i.useRef)(v()((function(t,e){var n=Object.values(a).filter((function(e){return e.name.zh.includes(t)||e.name.en.toLowerCase().includes(t.toLowerCase())})).map((function(t){return{label:"".concat(t.name[l.language]," - ").concat(s("\u8eca\u7ad9")),location:t.location}})).slice(0,10);u.current.abort(),u.current=new AbortController,j(t,{signal:u.current.signal}).then((function(t){e(n.concat(t.map((function(t){var e=t.name,n=t.address,r=t.lat,a=t.lng;return{label:[e[l.language],n[l.language]].filter((function(t){return t})).join(" - "),location:{lat:r,lng:a}}}))))}))}),200)).current;return(0,k.jsx)(y,{isClearable:!0,value:o,loadOptions:d,placeholder:n,onChange:r,classNamePrefix:"react-select"})},y=(0,m.ZP)(Z.ZP)((function(t){var e=t.theme;return{".react-select__control":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),border:"none !important",borderRadius:"unset !important",borderBottom:"1px hsl(0, 0%, 80%) solid !important"},".react-select__input":{color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__valueContainer":{color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__single-value":{color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__option:hover":{filter:"grayscale(1) !important"},".react-select__option--is-focused":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important")},".react-select__option--is-selected":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__menu":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")},".react-select__meauList":{background:"".concat("dark"===e.palette.mode?e.palette.background.default:"white"," !important"),color:"".concat("dark"===e.palette.mode?e.palette.primary.main:e.palette.text.primary," !important")}}})),w=n(8492),I=n(9282),L=n(1872),_=n(575),N=n(9530),R=n(3310),S=function(t){var e=t.routes,n=t.idx,r=t.handleRouteClick,a=t.expanded,o=t.stopIdx,c=(0,i.useContext)(f.Z).db,s=c.routeList,l=c.stopList,d=(0,h.$)(),p=d.t,m=d.i18n;return(0,k.jsxs)(F,{TransitionProps:{unmountOnExit:!0},classes:{root:O.root,expanded:O.expandedAccordion},onChange:function(){return r(n)},expanded:a,children:[(0,k.jsx)(w.Z,{classes:{root:O.summaryRoot,content:O.content,expanded:O.summaryExpanded},children:(0,k.jsx)(I.Z,{primary:e.map((function(t,e){var r=t.routeId,a=s[r],o=a.route,c=a.serviceType;return(0,k.jsxs)("span",{className:O.routeNo,children:[(0,k.jsx)(N.Z,{routeNo:o}),parseInt(c,10)>=2&&(0,k.jsx)(u.Z,{variant:"caption",className:O.specialTrip,children:p("\u7279\u5225\u73ed")})]},"search-".concat(n,"-").concat(e))})),secondary:function(t){var e=[];t.forEach((function(t){var n=t.routeId,r=t.on,a=s[n],o=a.fares,c=a.stops;e.push(l[Object.values(c).sort((function(t,e){return e.length-t.length}))[0][r]].name[m.language]+(o?" ($".concat(o[r],")"):""))}));var n=t[t.length-1],r=n.routeId,a=n.off,o=s[r].stops;return e.concat(l[Object.values(o).sort((function(t,e){return e.length-t.length}))[0][a]].name[m.language]).join(" \u2192 ")}(e)})}),(0,k.jsx)(L.Z,{classes:{root:O.details},children:e.map((function(t,e){return(0,k.jsx)(R.Z,{routeId:t.routeId.toUpperCase(),seq:t.on+(o?o[e]:0),containerClass:O.timerReport,showStopName:!0},"timereport-".concat(n,"-").concat(e))}))})]})},E="search-result",O={root:"".concat(E,"-root"),expandedAccordion:"".concat(E,"-expanded"),summaryRoot:"".concat(E,"-summary-root"),summaryExpanded:"".concat(E,"-summary-root-expanded"),content:"".concat(E,"-content"),details:"".concat(E,"-details"),timerReport:"".concat(E,"-timer-report"),routeNo:"".concat(E,"-route-no"),specialTrip:"".concat(E,"-special-trip")},F=(0,m.ZP)(_.Z)((function(t){var e,n=t.theme;return e={},(0,r.Z)(e,"&.".concat(O.root),(0,r.Z)({border:"1px solid rgba(0, 0, 0, .125)",boxShadow:"none","&:not(:last-child)":{borderBottom:0},"&:before":{display:"none"}},"&.".concat(O.expandedAccordion),{margin:"auto"})),(0,r.Z)(e,"& .".concat(O.summaryRoot),(0,r.Z)({backgroundColor:"dark"===n.palette.mode?n.palette.background.default:"rgba(0, 0, 0, .03)",borderBottom:"1px solid rgba(0, 0, 0, .125)",marginBottom:-1,minHeight:44},"&.".concat(O.summaryExpanded),{minHeight:44})),(0,r.Z)(e,"& .".concat(O.content),(0,r.Z)({margin:"8px 0",flexDirection:"column"},"&.".concat(O.summaryExpanded),{margin:"8px 0"})),(0,r.Z)(e,"& .".concat(O.details),{padding:n.spacing(2),paddingTop:n.spacing(1),paddingBottom:n.spacing(1),display:"flex"}),(0,r.Z)(e,"& .".concat(O.timerReport),{width:"50%"}),(0,r.Z)(e,"& .".concat(O.routeNo),{width:"50%",display:"inline-block"}),(0,r.Z)(e,"& .".concat(O.specialTrip),{fontSize:"0.6rem",marginLeft:"8px"}),e})),T=n(2379),P=n(5465),B=n(9024),z=n(705),M=n(1190),A=n(1071),$=n(7248),D=n.n($),q=n(7308),H=n(5823),W=function(t){var e=t.center,n=t.start,r=t.end,a=(0,T.Sx)();return e?a.flyTo((0,H.bf)(e)):r&&a.fitBounds(D().latLngBounds(D().latLng(n.lat,n.lng),D().latLng(r.lat,r.lng))),(0,k.jsx)(k.Fragment,{})},U=function(){var t=(0,i.useContext)(f.Z),e=t.geolocation;return"granted"!==t.geoPermission?null:(0,k.jsx)(P.C,{center:(0,H.bf)(e),radius:25})},G=function(t){var e=t.start;return e?(0,k.jsx)(B.J,{position:e,icon:et({isStart:!0})}):null},J=function(t){var e=t.end;return e?(0,k.jsx)(B.J,{position:e,icon:et({isStart:!1})}):null},Y=function(t){var e=t.onClick;return(0,k.jsx)("div",{className:"leaflet-bottom leaflet-right",children:(0,k.jsx)(ot,{className:"".concat(rt.centralControlContainer," leaflet-control leaflet-bar"),onClick:e,children:(0,k.jsx)(q.Z,{className:rt.centralControl})})})},K=function(t){var e=t.route,n=e.routeId,r=e.on,a=e.off,o=t.lv,c=t.stopIdx,s=t.onMarkerClick,l=(0,i.useContext)(f.Z).db,u=l.routeList,d=l.stopList,p=(0,h.$)().i18n,m=Object.values(u[n].stops).sort((function(t,e){return e.length-t.length}))[0].slice(r,a+1),g=n.split("-")[0];return(0,k.jsxs)(k.Fragment,{children:[m.map((function(t,e){return(0,k.jsx)(B.J,{position:d[t].location,icon:tt({active:c===e,passed:e<c,lv:o}),alt:"".concat(e,". ").concat(g," - ").concat(d[t].name[p.language]),eventHandlers:{click:function(t){s(n,e)}}},"".concat(t,"-").concat(e))})),m.slice(1).map((function(t,e){return(0,k.jsx)(z.a,{positions:[X(d[m[e]].location),X(d[t].location)],color:0===o?"#FF9090":"#d0b708"},"".concat(t,"-line"))}))]})},Q=function(t){var e=t.routes,n=t.start,r=t.end,a=(0,i.useContext)(f.Z).db,o=a.routeList,c=a.stopList,s=[],l=[];if(!n||!r)return(0,k.jsx)(k.Fragment,{});l.push(n),(e||[]).forEach((function(t){var e=t.routeId,n=t.on,r=t.off,a=Object.values(o[e].stops).sort((function(t,e){return e.length-t.length}))[0];l.push(c[a[n]].location),l.push(c[a[r]].location)})),l.push(r||n);for(var u=0;u<l.length/2;++u)s.push([l[2*u],l[2*u+1]]);return(0,k.jsx)(k.Fragment,{children:s.map((function(t,e){return(0,k.jsx)(z.a,{positions:[X(t[0]),X(t[1])],color:"green"},"line-".concat(e))}))})},V=function(t){var e=t.routes,n=t.start,r=t.end,a=t.stopIdx,c=t.onMarkerClick,s=(0,i.useContext)(f.Z),l=s.geolocation,u=s.geoPermission,d=s.updateGeoPermission,p=s.colorMode,m=(0,i.useState)({center:null,isFollow:!1}),g=(0,o.Z)(m,2),h=g[0],x=g[1],v=h.center,Z=h.isFollow,b=(0,i.useState)(null),j=(0,o.Z)(b,2),C=j[0],y=j[1],w=function(t){var e=t.center,n=t.isFollow,r=void 0!==n&&n;x({center:e||C.getCenter(),isFollow:r})};return(0,i.useEffect)((function(){if(C)return C.on("dragend",w),function(){C.off("dragend",w)}}),[C]),(0,i.useEffect)((function(){Z&&(l.lat===v.lat&&l.lng===v.lng||w({center:l,isFollow:!0}))}),[l]),(0,k.jsx)(at,{className:rt.mapContainerBox,children:(0,k.jsxs)(M.h,{center:v||(n&&r?{lat:(n.lat+r.lat)/2,lng:(n.lng+r.lng)/2}:(0,H.bf)(n)),zoom:16,scrollWheelZoom:!1,className:rt.mapContainer,whenCreated:y,children:[(0,k.jsx)(W,{center:v,start:(0,H.bf)(n),end:r}),(0,k.jsx)(A.I,{attribution:'\xa9 <a href="http://osm.org/copyright">OpenStreetMap</a> contributors \xa9 <a href="https://carto.com/attributions">CARTO</a>',url:"dark"===p?"https://{s}.basemaps.cartocdn.com/rastertiles/light_all/{z}/{x}/{y}.png":"https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png"}),(e||[]).map((function(t,e){return(0,k.jsx)(K,{route:t,lv:e,stopIdx:a[e],onMarkerClick:c},"route-".concat(e))})),(0,k.jsx)(Q,{routes:e,start:n,end:r}),(0,k.jsx)(U,{}),(0,k.jsx)(G,{start:n}),(0,k.jsx)(J,{end:r}),(0,k.jsx)(Y,{onClick:function(){"granted"===u?w({center:(0,H.bf)(l),isFollow:!0}):"denied"!==u&&(w({isFollow:!0}),d("opening"))}})]})})},X=function(t){return[t.lat,t.lng]},tt=function(t){var e=t.active,n=t.passed,r=t.lv;return D().icon({iconUrl:"https://unpkg.com/leaflet@1.0.1/dist/images/marker-icon-2x.png",className:"".concat(rt.marker," ").concat(e?rt.active:""," ").concat(n?rt.passed:""," lv-").concat(r)})},et=function(t){var e=t.isStart;return D().icon({iconUrl:"https://unpkg.com/leaflet@1.0.1/dist/images/marker-icon-2x.png",className:"".concat(rt.marker," ").concat(e?"start":"end")})},nt="searchMap",rt={mapContainerBox:"".concat(nt,"-mapContainerBox"),mapContainer:"".concat(nt,"-mapContainer"),centralControlContainer:"".concat(nt,"-centralControlContainer"),centralControl:"".concat(nt,"-centralControl"),marker:"".concat(nt,"-marker"),active:"".concat(nt,"-active"),passed:"".concat(nt,"-passed")},at=(0,m.ZP)(s.Z)((function(t){var e,n=t.theme;return e={},(0,r.Z)(e,"&.".concat(rt.mapContainerBox),{height:"30vh",filter:"dark"===n.palette.mode?"brightness(0.8)":"none"}),(0,r.Z)(e,"& .".concat(rt.mapContainer),{height:"30vh"}),(0,r.Z)(e,"& .".concat(rt.marker),{marginLeft:"-12px",marginTop:"-41px",width:"25px",height:"41px",zIndex:618,outline:"none",filter:"hue-rotate(130deg)","&.lv-1":{filter:"hue-rotate(210deg) brightness(1.5)"},"&.start":{filter:"hue-rotate(30deg)"},"&.end":{filter:"hue-rotate(280deg)"}}),(0,r.Z)(e,"& .".concat(rt.active),{animation:"blinker 2s linear infinite"}),(0,r.Z)(e,"& .".concat(rt.passed),{filter:"grayscale(100%)"}),e})),ot=(0,m.ZP)("div")((function(t){var e;t.theme;return e={},(0,r.Z)(e,"& .".concat(rt.centralControl),{padding:"5px",color:"black"}),(0,r.Z)(e,"&.".concat(rt.centralControlContainer),{background:"white",height:"28px",marginBottom:"20px !important",marginRight:"5px !important"}),e})),ct=n(7420),it=function(){var t=(0,h.$)().t;return(0,k.jsxs)("div",{className:ut.description,children:[(0,k.jsx)(u.Z,{variant:"h5",children:t("Route Search header")}),(0,k.jsx)(d.Z,{}),(0,k.jsx)(u.Z,{variant:"subtitle1",children:t("Route Search description")}),(0,k.jsx)("br",{}),(0,k.jsx)(u.Z,{variant:"body2",children:t("Route Search constraint")}),(0,k.jsxs)(u.Z,{variant:"body2",children:["1. ",t("Route Search caption 1")]}),(0,k.jsxs)(u.Z,{variant:"body2",children:["2. ",t("Route Search caption 2")]}),(0,k.jsxs)(u.Z,{variant:"body2",children:["3. ",t("Route Search caption 3")]})]})},st=function(){var t=(0,h.$)(),e=t.t,n=t.i18n,r=(0,i.useContext)(f.Z),u=r.AppTitle,d=r.geolocation,p=r.energyMode,m=r.db,x=m.routeList,v=m.stopList,Z=r.vibrateDuration,b=(0,i.useContext)(g.Z),j=b.locations,y=b.setLocations,w=b.status,I=b.setStatus,L=b.result,_=b.setResult,N=b.resultIdx,R=b.setResultIdx,E=(0,i.useRef)(void 0),O=function(){E.current&&(E.current.terminate(),E.current=void 0)};(0,i.useEffect)((function(){(0,H.ND)({title:e("\u9ede\u5c0d\u9ede\u8def\u7dda\u641c\u5c0b")+" - "+e(u),description:e("route-search-page-description"),lang:n.language})}),[n.language]),(0,i.useEffect)((function(){"rendering"===w&&I("ready")}),[L]),(0,i.useEffect)((function(){return"waiting"===w&&j.end&&window.Worker&&(O(),E.current=new Worker("/search-worker.js"),E.current.postMessage({routeList:x,stopList:v,start:j.start?j.start.location:d,end:j.end.location,maxDepth:2}),E.current.onmessage=function(t){if("done"===t.data.type)return O(),void I(t.data.count?"rendering":"ready");!function(t){var e=t.reduce((function(t,e){return t.concat.apply(t,(0,c.Z)(e.map((function(t){return["".concat(t.routeId,"/").concat(t.on),"".concat(t.routeId,"/").concat(t.off)]}))))}),[]).filter((function(t,e,n){return n.indexOf(t)===e}));Promise.all(e.map((function(t){var e=t.split("/"),r=(0,o.Z)(e,2),c=r[0],i=r[1];return navigator.onLine?(0,ct.fetchEtas)((0,a.Z)((0,a.Z)({},x[c]),{},{seq:parseInt(i,10),routeStops:x[c].stops,co:Object.keys(x[c].stops),language:n.language})):new Promise((function(t){return t([])}))}))).then((function(t){return e.filter((function(e,n){return!navigator.onLine||t[n].length&&t[n].reduce((function(t,e){return t||e.eta}),null)}))})).then((function(e){_((function(n){return[].concat((0,c.Z)(n),(0,c.Z)(t.filter((function(t){return t.reduce((function(t,n){return t&&(-1!==e.indexOf("".concat(n.routeId,"/").concat(n.on))||-1!==e.indexOf("".concat(n.routeId,"/").concat(n.off)))}),!0)})).map((function(t){var e=j.start?j.start.location:d;return t.map((function(t,n){for(var r=Object.values(x[t.routeId].stops).sort((function(t,e){return e.length-t.length}))[0],o=-1,c=1e5,i=t.on;i<t.off;++i){var s=(0,H.Sp)(v[r[i]].location,e);s<c&&(o=i,c=s)}return e=v[r[t.off]].location,(0,a.Z)((0,a.Z)({},t),{},{on:o})}))})).map((function(t){return[t,t.reduce((function(t,e){return t+e.off-e.on}),0)]})).sort((function(t,e){return t[1]-e[1]})).map((function(t){return t[0]}))))}))}))}(t.data.value.sort((function(t,e){return t.length-e.length})))}),function(){O()}}),[w,j]);var F=function(t){(0,H.tp)(Z),setTimeout((function(){R({resultIdx:t,stopIdx:[0,0]})}),0)};return(0,k.jsxs)(dt,{className:ut.root,square:!0,elevation:0,children:[p?null:(0,k.jsx)(V,{start:j.start?j.start.location:d,end:j.end?j.end.location:null,routes:L[N.resultIdx],stopIdx:N.stopIdx,onMarkerClick:function(t,e){var n=L[N.resultIdx].map((function(t){return t.routeId})).indexOf(t);R((function(t){var r=(0,c.Z)(t.stopIdx);return r[n]=e,(0,a.Z)((0,a.Z)({},t),{},{stopIdx:r})}))}}),(0,k.jsxs)("div",{className:ut.inputContainer,children:[(0,k.jsx)(C,{value:j.start,placeholder:e("\u4f60\u7684\u4f4d\u7f6e"),onChange:function(t){y((0,a.Z)((0,a.Z)({},j),{},{start:t})),I("waiting"),R({resultIdx:0,stopIdx:[0,0]}),_([])},stopList:v}),(0,k.jsx)(C,{value:j.end,placeholder:e("\u76ee\u7684\u5730"),onChange:function(t){y((0,a.Z)((0,a.Z)({},j),{},{end:t})),t&&I("waiting"),R({resultIdx:0,stopIdx:[0,0]}),_([])},stopList:v})]}),(0,k.jsx)(s.Z,{className:p?ut.resultListEnergy:ut.resultList,children:j.end?"waiting|rendering".includes(w)&&0===L.length?(0,k.jsx)(l.Z,{size:30,className:ut.routeLoading}):"ready|waiting|rendering".includes(w)&&L.length?L.map((function(t,e){return(0,k.jsx)(S,{routes:t,idx:e,handleRouteClick:F,expanded:e===N.resultIdx,stopIdx:e===N.resultIdx?N.stopIdx:null},"search-result-".concat(e))})):(0,k.jsx)(k.Fragment,{children:e("\u627e\u4e0d\u5230\u5408\u9069\u7684\u5df4\u58eb\u8def\u7dda")}):(0,k.jsx)(it,{})})]})},lt="search",ut={root:"".concat(lt,"-root"),inputContainer:"".concat(lt,"-input-container"),description:"".concat(lt,"-description"),resultList:"".concat(lt,"-result-list"),resultListEnergy:"".concat(lt,"-result-list-energy"),routeLoading:"".concat(lt,"-route-loading")},dt=(0,m.ZP)(p.Z)((function(t){var e,n=t.theme;return e={},(0,r.Z)(e,"&.".concat(ut.root),{background:"dark"===n.palette.mode?n.palette.background.default:"white",height:"calc(100vh - 125px)",overflowY:"hidden",textAlign:"left"}),(0,r.Z)(e,".search-input-container",{marginTop:"2%",padding:"0% 2%"}),(0,r.Z)(e,".search-description",{textAlign:"left",marginTop:"5%",padding:"5%"}),(0,r.Z)(e,".search-result-list",{overflowY:"scroll",height:"calc(100% - 30vh - 76px)"}),(0,r.Z)(e,".search-result-list-energy",{overflowY:"scroll",height:"calc(100% - 76px)"}),(0,r.Z)(e,".search-route-loading",{margin:"10%"}),e}))}}]);